<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/decimal9.js | Public API | Meeks-PRF-js</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Tabulate Meek&apos;s method using prfound.org reference rule, with extensions"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Public API | Meeks-PRF-js"><meta property="twitter:description" content="Tabulate Meek&apos;s method using prfound.org reference rule, with extensions"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ballot.js~Ballot.html">Ballot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/decimal9.js~Decimal9.html">Decimal9</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/decimal9.js~Decimal9Error.html">Decimal9Error</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/decimal9.js~Decimal9Total.html">Decimal9Total</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~MeekImplementationError.html">MeekImplementationError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~MeekValueError.html">MeekValueError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/meek.js~Tabulation.html">Tabulation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/progress.js~Progress.html">Progress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/results.js~Results.html">Results</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/status.js~Status.html">Status</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/util_basic.js~UtilBaseError.html">UtilBaseError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/util_basic.js~UtilBasicFunctions.html">UtilBasicFunctions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/util_basic.js~UtilValueError.html">UtilValueError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validate.js~Validator.html">Validator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/with_json.js~WithJson.html">WithJson</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-tabulate">tabulate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-K">K</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UBF">UBF</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/decimal9.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * @copyright 2016-2019 David Cary;
 * @license Apache-2.0
 *
 * @module Decimal9
 */
 /**
 * @summary Support for decimals with nine decimal places.
 */

import {UtilBaseError} from &apos;./util_basic.js&apos;;
import BigInt from &apos;./big-integer.js&apos;;

const _NBR_DECIMAL_PLACES = 9;
const _FACTOR = Math.pow(10, _NBR_DECIMAL_PLACES);
const _FACTOR_BIGINT = BigInt(_FACTOR);

const BIGINT_ONE = BigInt(1);
const BIGINT_MINUS_ONE = BigInt(-1);
const BIGINT_TWO = BigInt(2);

/** An error type used with the Decimal9 class. */
class Decimal9Error extends UtilBaseError {
  /** The calling convention is the same as for UtilBaseError.
   * Initialize with a message, other values, and a prior error. */
  constructor(message, otherValues=[], priorError=null) {
    super(message, otherValues, priorError);
  }
}

/** Unit of least precision.
 * @return {Decimal9} A value of the smallest positive value represented
 *   by a Decimal9 value: 1 * 10^-9 = 0.000000001. */
function _ulp() {
  const result = new Decimal9(1, -_NBR_DECIMAL_PLACES);
  return result;
}

/** An immutable class for expressing numbers to nine decimal places.
 *
 * This is useful for counting votes in STV tabulations.
 *
 * This class provides defined behavior, relatively free from
 * external influences, providing values are kept within a safe range.
 * Internally, values are stored as integer Javascript number values.
 *
 * Values that are outside the safe range may not be relied upon
 * to provide accurate results. It is the responsibilty of code using this
 * class to ensure that values stay within the safe range.
 *
 * Multiplication and division can require greater precision in
 * intermediate results before rounding or truncation than Javascript
 * numbers can provide.
 *
 * To support the required capacity for numerical precision, the Javascript
 * numbers are converted to big integers, currently using the npm
 * big-integer package and BigInt() constructor, for performing
 * multiplication and division.
 * The results, after applicable rounding
 * (including truncation) are converted back to native Javascript numbers.
 * It is left to the application to check or otherwise ensure that the
 * resulting values can be adequately represented as safe Javascript
 * integers.
 */
class Decimal9 extends Object {
  /**
   * @param {number|Number|Decimal9|null} [value=null] - A numeric value that
   *   the new instance should represent; if null, the result is zero.
   * @param {number} [exponentOf10=0] - Number indicating how many powers of 10
   *   the `value` should be be multiplied by to get the instance&apos;s true
   *   numeric value; `exponentOf10` can be negative.
   * @throw {Decimal9Error} If either `value` or `exponentOf10` is not a
   *   supported value or type.
   */
  constructor(value=null, exponentOf10=0) {
    super();
    const roundedExponentOf10 = Math.round(exponentOf10);
    if (!Number.isInteger(roundedExponentOf10)) {
      throw new Decimal9Error(&apos;exponentOf10 is not a supported value:&apos;, [
        [&apos;type&apos;, typeof exponentOf10],
        [&apos;rounded exponentOf10&apos;, roundedExponentOf10],
        [&apos;exponentOf10&apos;, exponentOf10],
      ]);
    }
    exponentOf10 = roundedExponentOf10;
    if (value === null) {
      this._valueAsInteger = 0;
      return;
    }
    if (value instanceof Decimal9) {
      if (exponentOf10 === 0) {
        this._valueAsInteger = value._valueAsInteger;
      } else if (exponentOf10 &gt; 0) {
        const multiplier = Math.pow(10, exponentOf10);
        this._valueAsInteger = value._valueAsInteger * multiplier;
      } else {
        const divisor = Math.pow(10, -exponentOf10);
        const division = _integerDivide(value._valueAsInteger, divisor);
        this._valueAsInteger = _round(division.q, division.r,
              division.d, &apos;nearest&apos;);
      }
      return;
    }
    if (typeof value == &apos;object&apos; &amp;&amp; value instanceof Number) {
      value = Number(value);
    }
    if (typeof value == &apos;number&apos;) {
      const adjustedExponent = exponentOf10 + _NBR_DECIMAL_PLACES;
      const multiplier = Math.pow(10, adjustedExponent);
      const adjustedValue = value * multiplier;
      if (Math.trunc(value) === value) {
        if (adjustedExponent &gt;= 0) {
          this._valueAsInteger = value * multiplier;
        } else {
          this._valueAsInteger = Math.trunc(adjustedValue);
        }
      } else {
        this._valueAsInteger = Math.round(adjustedValue);
      }
      return;
    } else {
      throw new Decimal9Error(&apos;Value is not a supported type:&apos;, [
        [&apos;type&apos;, typeof value],
        [&apos;value of value&apos;, value.toString()],
      ]);
    }
  }

  /** Get the underlying integer value.
   * @return {number} The underlying JavaScript integer value used to
   *   internally represent the Decimal9 value; this may not be accurate
   *   if the value is not a safe Javascript integer. */
  _getValue() {
    return this._valueAsInteger;
  }

  /** Get the Decimal9 value as a Javascript number.
   * @return {number} A representation of the Decimal9 value as a Javascript
   *   number. */
  toNumber() {
    // Get the value as a javascript number.
    const result = this._getValue() / _FACTOR;
    return result;
  }

  /** The max safe integer value that Decimal9 uses internally,
   *  as a static class value.
   *
   * This represents a slightly smaller number than Javascript uses, since
   * Javascript has some conversion anomalies for what it deems to be
   * safe integers.
   *
   * The value is 9000100000000000 = 9,000,100,000,000,000. */
  static get MAX_SAFE_INTEGER() { return 9000100000000000; }
  /** The negative of Decimal9.MAX_SAFE_INTEGER. */
  static get MIN_SAFE_INTEGER() { return -Decimal9.MAX_SAFE_INTEGER; }
  /** The maximum value that Decimal9 deems safe to work with.
   *
   * The value is 9000100 = 9,000,100 , i.e. nine million one hundred. */
  static get MAX_SAFE_VALUE() { return 9000100; }
  /** The negative of Decimal9.MAX_SAFE_VALUE. */
  static get MIN_SAFE_VALUE() { return -Decimal9.MAX_SAFE_VALUE; }

  /** Convert the Decimal9 value to a string, showing all decimal places,
   * even if they include trailing zeros.
   * @return {string} A string reflecting the represented numeric value. */
  toString() {
    const parts = _integerDivide(new BigInt(this._valueAsInteger), _FACTOR);
    parts.r = parts.r.toJSNumber();
    let result = parts.q.abs().toString() + &apos;.&apos; +
          Math.abs(parts.r).toString().padStart(9, &apos;0&apos;);
    result = result.replace(/0{1,8}$/, &apos;&apos;);
    parts.q = parts.q.toJSNumber();
    if (parts.q &lt; 0 || (parts.q === 0 &amp;&amp; parts.r &lt; 0)) {
      result = &apos;-&apos; + result;
    }
    return result
  }

  /** Test whether the Decimal9 value is in the safe range.
   * @return {boolean} A true/false indication of whether the Decimal9
   *   value is within the safe range, endpoints included. */
  isSafe() {
    if (this._valueAsInteger &gt;= Decimal9.MIN_SAFE_INTEGER &amp;&amp;
          this._valueAsInteger &lt;= Decimal9.MAX_SAFE_INTEGER) {
      return true;
    } else {
      return false;
    }
  }

  /** Test whether this Decimal9 value is less than another one.
   * @param {Decimal9} value - A Decimal9 instance to compare with.
   * @return {boolean} A true/false indication of whether this numeric value
   *   is less than the numeric value of the argument. */
  isLess(value) {
    _confirmTypes(value, Decimal9);
    const result = this._valueAsInteger &lt; value._valueAsInteger;
    return result;
  }

  /** Test whether this Decimal9 value is less than or equal to another one.
   * @param {Decimal9} value - A Decimal9 instance to compare with.
   * @return {boolean} A true/false indication of whether this numeric value
   *   is less than or equal to the numeric value of the argument. */
  isLessEqual(value) {
    _confirmTypes(value, Decimal9);
    const result = this._valueAsInteger &lt;= value._valueAsInteger;
    return result;
  }

  /** Test whether this Decimal9 value is equal to another one.
   * @param {Decimal9} value - A Decimal9 instance to compare with.
   * @return {boolean} A true/false indication of whether this numeric value
   *   is equal to the numeric value of the argument. */
  isEqual(value) {
    if (value === null) {
      return false;
    }
    _confirmTypes(value, Decimal9);
    /*
    if (!(value instanceof Decimal9)) {
      return false;
    }
    */
    const result = this._valueAsInteger === value._valueAsInteger;
    return result;
  }

  /** Test whether this Decimal9 value is not equal to another one.
   * @param {Decimal9} value - A Decimal9 instance to compare with.
   * @return {boolean} A true/false indication of whether this numeric value
   *   is not equal to the numeric value of the argument. */
  isNotEqual(value) {
    const result = !this.isEqual(value);
    return result;
  }

  /** Test whether this Decimal9 value is greater than or equal to another one.
   * @param {Decimal9} value - A Decimal9 instance to compare with.
   * @return {boolean} A true/false indication of whether this numeric value
   *   is greater than or equal to the numeric value of the argument. */
  isGreaterEqual(value) {
    _confirmTypes(value, Decimal9);
    const result = this._valueAsInteger &gt;= value._valueAsInteger;
    return result;
  }

  /** Test whether this Decimal9 value is greater than another one.
   * @param {Decimal9} value - A Decimal9 instance to compare with.
   * @return {boolean} A true/false indication of whether this numeric value
   *   is greater than the numeric value of the argument. */
  isGreater(value) {
    _confirmTypes(value, Decimal9);
    const result = this._valueAsInteger &gt; value._valueAsInteger;
    return result;
  }

  /** Add a value to this value, producing a new value.
   *
   * @param {Decimal9} value - The value to be added to this one.
   * @return {Decimal9} The sum of this and value. */
  plus(value) {
    _confirmTypes(value, Decimal9);
    const asInteger = this._valueAsInteger + value._valueAsInteger;
    const result = new Decimal9(asInteger, -_NBR_DECIMAL_PLACES);
    return result;
  }

  /** Subtract a value from this value, producing a new value.
   *
   * @param {Decimal9} value - The value to be subtracted from this one.
   * @return {Decimal9} The difference of this minus value. */
  minus(value) {
    _confirmTypes(value, Decimal9);
    const asInteger = this._valueAsInteger - value._valueAsInteger;
    const result = new Decimal9(asInteger, -_NBR_DECIMAL_PLACES);
    return result;
  }

  /** Arithmetically negate this value, producing a new value.
   *
   * @return {Decimal9} The negative of this. */
  negative() {
    const asInteger = -this._valueAsInteger;
    const result = new Decimal9(asInteger, -_NBR_DECIMAL_PLACES);
    return result;
  }

  /** Multiply this value by another value, producing a new value.
   *
   * @param {Decimal9|number|Number} value - The value to be multiplied by.
   *   this one
   * @param {string} [rounding=&apos;truncate&apos;] - An indication of what kind of
   *   rounding should be done.  Should be a value in K.ROUND:
   *
   *   - &apos;truncate&apos; = Truncate any value beyond 9 decimal places.
   *   - &apos;away&apos; = Round away from zero to 9 decimal places.
   *   - &apos;nearest&apos; = Round to the nearest 9-decimal-place value,
   *       rounding to an even digit in the 9th decimal place if there
   *       is a tie for the nearest value.
   * @return {Decimal9} The product of the two values, rounded as requested. */
  times(value, rounding=&apos;truncate&apos;) {
    _confirmTypes(value, Decimal9, &apos;number&apos;, Number);
    if (!(value instanceof Decimal9)) {
      value = new Decimal9(value);
    }
    const product = new BigInt(this._valueAsInteger)
          .multiply(new BigInt(value._valueAsInteger));
    const scaledProduct = _integerDivide(product, _FACTOR);
    const asInteger = _round(scaledProduct.q, scaledProduct.r, _FACTOR,
          rounding);
    const result = new Decimal9(asInteger, -_NBR_DECIMAL_PLACES);
    return result;
  }

  /** Divide this value by another value, producing a new value.
   *
   * @param {Decimal9|number|Number} value - The divisor value.
   * @param {string} [rounding=&apos;truncate&apos;] - An indication of what kind of
   *   rounding should be done.  Should be a value in K.ROUND:
   *
   *   - &apos;truncate&apos; = Truncate any value beyond 9 decimal places.
   *   - &apos;away&apos; = Round away from zero to 9 decimal places.
   *   - &apos;nearest&apos; = Round to the nearest 9-decimal-place value,
   *       rounding to an even digit in the 9th decimal place if there
   *       is a tie for the nearest value.
   * @return {Decimal9} The quotient of this divided by value, after any
   *   indicated rounding. */
  divideBy(value, rounding=&apos;truncate&apos;) {
    _confirmTypes(value, Decimal9, &apos;number&apos;, Number);
    if (!(value instanceof Decimal9)) {
      value = new Decimal9(Number(value));
    }
    if (value._valueAsInteger === 0) {
      throw new Decimal9Error(&apos;Divide by zero.&apos;);
    }
    const division = _integerDivide(
          BigInt(this._valueAsInteger).multiply(_FACTOR_BIGINT),
          BigInt(value._valueAsInteger));
    const asInteger = _round(division.q, division.r,
          division.d.abs(), rounding);
    const result = new Decimal9(asInteger, -_NBR_DECIMAL_PLACES);
    return result;
  }

}

Decimal9.ulp = _ulp;

/** A mutable subclass of Decimal9 for accumulating totals.
 *
 * Totals can be accumulated through standard addition and subtraction
 * operations, `plus` and `minus`, without creating new instances.
 *
 * The constructor does not take any parameters and always initializes
 * a new instance to a zero value.
 */
class Decimal9Total extends Decimal9 {

  constructor() {
    super();
    this._valueAsInteger = 0;
  }

  /** Add a value to this value, accumulating the result in this.
   *
   * @param {Decimal9} value - The value to be added to this one
   * @return {Decimal9Total} This, which now carries the sum. */
  plus(value) {
    _confirmTypes(value, Decimal9);
    this._valueAsInteger += value._valueAsInteger;
    return this;
  }

  /** Subtract a value from this value, accumulating the result in this.
   *
   * @param {Decimal9} value - The value to be subtracted from this one
   * @return {Decimal9Total} This, which now carries the difference. */
  minus(value) {
    _confirmTypes(value, Decimal9);
    this._valueAsInteger -= value._valueAsInteger;
    return this;
  }
}

/** Perform big integer division.
 * @param {number|big-integer} numerator - The numerator.
 * @param {number|big-integer} denominator - The denominator.
 * @return {Object} A data object containing the quotient, remainder, and
 * denominator, all as big integers.
 */
function _integerDivide(numerator, denominator) {
  // return BigInt quotient , remainder, and denominator.
  // first convert numerator and denominator to BigInt&apos;s as needed.
  if (typeof numerator === &apos;number&apos;) {
    numerator = BigInt(numerator);
  }
  if (typeof denominator === &apos;number&apos;) {
    denominator = BigInt(denominator);
  }
  const division = numerator.divmod(denominator);
  const result = { q: division.quotient, r: division.remainder,
        d: denominator};
  return result;
}

/** Round a big integer value based on its remainder, a modulus, and
 *  a rounding setting of &apos;truncate&apos;, &apos;away&apos;, or &apos;nearest&apos;.
 *  @param {big-integer} asInteger - The value to round.
 *  @param {big-integer} remainder - The remainder to be rounded.
 *  @param {big-integer} modulus - Round to multiples of this value.
 *  @param {string} rounding - Values of &apos;truncate&apos;, &apos;away&apos;, or &apos;nearest&apos;.
 *  @return {number} A Javascript integer appropriately rounded.
 */
function _round(asInteger, remainder, modulus, rounding=&apos;truncate&apos;) {
  // Round the value of asInteger + remainder / modulus to an integer.
  //
  // Return a Javascript number
  //
  // Give the correct answer whenever it and asInteger are safe integers.
  //
  // Assumptions:
  //   asInteger, remainder, and modulus are BigInt integers.
  //   //NOT ASSUMED: asInteger and remainder are the same sign or one of them
  //         is zero.
  //   //NOT ASSUMED: modulus is positive.
  //   Twice the modulus is a safe integer.
  //   remainder is less in absolute value than modulus.
  //
  // This function is only used internally, and the assumptions are not
  // asserted.
  if (rounding === &apos;away&apos; &amp;&amp; !remainder.isZero()) {
    asInteger = asInteger.plus(asInteger.isZero() ?
          (remainder.isPositive() ? BIGINT_ONE : BIGINT_MINUS_ONE) :
          (asInteger.isPositive() ? BIGINT_ONE : BIGINT_MINUS_ONE));
  } else if (rounding === &apos;nearest&apos;) {
    const factorCompare = remainder.abs().multiply(BIGINT_TWO);
    const modulusAbs = modulus instanceof BigInt ?
          modulus.abs() : Math.abs(modulus);
    if (factorCompare.gt(modulusAbs) ||
          (factorCompare.equals(modulusAbs) &amp;&amp; asInteger.isOdd())) {
      asInteger = asInteger.plus(asInteger.isZero() ?
            (remainder.isPositive() ? BIGINT_ONE : BIGINT_MINUS_ONE) :
            (asInteger.isPositive() ? BIGINT_ONE : BIGINT_MINUS_ONE));
    }
  }
  asInteger = asInteger.toJSNumber();
  return asInteger;
}

function _confirmTypes(value, ...requiredTypes) {
  /* Raise an Decimal9Error if value is not an instance of the
  required class or of the required type.
  */
  for (let requiredType of requiredTypes) {
    if ((typeof requiredType == &apos;string&apos; &amp;&amp; typeof value == requiredType) ||
          (value === null &amp;&amp; requiredType === null) ||
          ((typeof requiredType == &apos;object&apos; ||
            typeof requiredType == &apos;function&apos;) &amp;&amp;
            requiredType !== null &amp;&amp;
            value instanceof requiredType)) {
      return true;
    }
  }
  throw new Decimal9Error(
    &apos;Value is not an instance of the required type:&apos;, [
    [&apos;value type&apos;, typeof value],
    [&apos;value&apos;, String(value)],
    [&apos;required types&apos;, requiredTypes.map((x) =&gt; (&apos;: &apos; + x).slice(2,102))],
  ]);
}

export { Decimal9, Decimal9Total, Decimal9Error };

</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
